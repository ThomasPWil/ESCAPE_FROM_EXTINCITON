<!DOCTYPE html>

<html>

<head>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>

</head>

<body>

    <script>

    var config = {
        type: Phaser.AUTO,
        width: 1200,
        height: 700,
        physics: {
            default: 'arcade',
        },

        scene: {
            preload: preload,
            create: create,
            update: update,
        }

    };

    class Player extends Phaser.Physics.Arcade.Sprite
    {
        carrotsEaten = 0;
        totalJumps = 2;
        currentJumps = 0;
        lives = 3;
        constructor(scene, x, y)
        {
            super(scene, x, y, 'player');
            scene.add.existing(this);
            scene.physics.add.existing(this);
            this.setScale(2);
            this.setCollideWorldBounds(true);
            this.setGravityY(3000); //We will set gravity *per object* rather than for the scene!
        }
    }
     
    /*
    class Carrot extends Phaser.Physics.Arcade.Sprite
    {
        constructor(scene, x, y)
        {
            super(scene, x, y, 'carrot');
            scene.add.existing(this);
            scene.physics.add.existing(this);
            this.setCollideWorldBounds(true);
            this.setGravityY(1000);
        }
    }
      */

    class Lava extends Phaser.Physics.Arcade.Sprite
    {
        constructor(scene, x, y, spritesheet, animation)
        {
            super(scene, x, y, spritesheet);
            this.animation = animation;
            scene.add.existing(this);
            scene.physics.add.existing(this);
            this.setScale(2);
            this.setCollideWorldBounds(true);
            this.setGravityY(3000);
            this.play(animation);
        }
        addTween(scene, xDist, yDist, time)
        {
            scene.tweens.add({ targets: this, x: xDist, y: yDist, duration: time, ease: 'Sine.easeInOut', repeat: -1, yoyo: true });
        }
    }

    
    class Coin extends Phaser.Physics.Arcade.Sprite
    {
        constructor(scene, x, y, spritesheet, animation)
        {
            super(scene, x, y, spritesheet);
            this.animation = animation;
            scene.add.existing(this);
            scene.physics.add.existing(this);
            this.setScale(2);
            this.setCollideWorldBounds(true);
            this.setGravityY(3000);
            this.play(animation);
        }
        addTween(scene, xDist, yDist, time)
        {
            scene.tweens.add({ targets: this, x: xDist, y: yDist, duration: time, ease: 'Sine.easeInOut', repeat: -1, yoyo: true });
        }
    }

    var game = new Phaser.Game(config);

    //Game Objects
    var platforms;
    var CoinIcon;
    var player;
    var LavaGroup = [];
    var coinGroup = [];
    var coinsCollected = 0;
    var carrots = [];
    var totalCarrots = 12;
    var totalCoins = Phaser.Math.Between(0,20)
    var carrotsEaten = 0;
    var dashCoolDown = 4;
    var invisframes = 0;

    //Keyboard controls
    var cursors;
    var keys;
    var space;

    // GUI vars
    var gui;
    var guiTimer;
    var GOgui;
    var CoinGUI;

    function preload()
    {   
        this.load.image('sky', 'assets/clouds.png');
        this.load.image('platform', 'assets/platform.png');
        this.load.image('player', 'assets/wabbit.png');
        this.load.image('carrot', 'assets/carrot.png');
        this.load.image('coinIcon', 'Assets/Coin_icon.png');
        
        this.load.atlas('lava','Assets/lava.png','Assets/lava.json')

        this.load.atlas('coin','Assets/coin.png','Assets/coin.json')
    }

    function create()
    {
        //Set the background origin to be at (0, 0) or top left corner of the image rather than the center of the image asset
       let background = this.add.tileSprite(0, 0, game.scale.width, game.scale.height, 'sky').setOrigin(0, 0);
      
       //Create the platforms and the player character set to collide with the platforms
       createPlatforms(this);
       player = new Player(this, 250, 375);

       this.physics.add.collider(player, platforms);
       
      
       createCoinIcon(this);

       
       // creating lava and have it collide with player
       let lava_animations = {}
       
       var run_lava_anims = this.anims.create({key: 'lava-animation', frames: this.anims.generateFrameNames('lava', {prefix: 'lava/lava',  end:10 , zeroPad:3}),repeat:-1, frameRate:10});
       
       lava = new Lava(this, game.scale.width/2, game.scale.height,'lava', 'lava-animation');
       this.physics.add.overlap(player, lava, LavaCollide, null, this);
       lava.setScale(6.04, 1.5).refreshBody();
       
       LavaGroup.push(lava);

       // creating coin sprite and have it collide with player
       let coin_animations = {}
       
       var run_coin_anims = this.anims.create({key: 'coin-animation', frames: this.anims.generateFrameNames('coin', {prefix: 'coin/coin', end:3 , zeroPad:3}),repeat:-1, frameRate: 4});

       
       for (var i = 0; i < totalCoins; i++)
       {
       coin = new Coin(this, Phaser.Math.Between(0,300), Phaser.Math.Between(0,300),'coin', 'coin-animation')
       this.physics.add.overlap(player, coin, coinCollide, null, this);
       this.physics.add.collider(coin, platforms);
       coin.setScale(1.3, 1).refreshBody();

       coinGroup.push(coin);
       }
         
      
       


       //Create the carrot interactables
       /*for (var i = 0; i < totalCarrots; i++)
       {
           let myCarrot = new Carrot(this, Phaser.Math.Between(0, game.scale.width), Phaser.Math.Between(0, game.scale.height-80));
           this.physics.add.collider(myCarrot, platforms);
           carrots.push(myCarrot);
       }
       

       this.physics.add.overlap(player, carrots, eatCarrot, null, this);
       */

       //Set up user input
       cursors = this.input.keyboard.createCursorKeys();
       keys = this.input.keyboard.addKeys('A, D');
       space = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
       space.on('down', jump); //calls jump function when space is pressed
       q = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Q);
       q.on('down', dash); //calls jump function when space is pressed

       gui = this.add.text(16, 16, '', {fontSize: '32px', fill: '#000'});

       // code for game over text
       CoinGUI = this.add.text(1130,100,'0', {fontSize: '35px',fill: '#000'});

       GOgui = this.add.text(game.scale.width/2, 32, '',{fontSize: '100px', fill: "#000"})

       jumpGUI = this.add.text(500, 150, '', {fontSize: '32px', fill: '#000'});

       dashGUI = this.add.text(500, 182, '', {fontSize: '32px', fill: '#000'});

      
       

       if (player.lives <= 0)
       {
           
           GOgui.setText('GAME OVER');
           player.disableBody(true,true);


       }

    }

    function createPlatforms(scene)
    {
        platforms = scene.physics.add.staticGroup();

        //basePlatform is the floor of the game
        let basePlatform = platforms.create(game.scale.width/2, game.scale.height-30, 'platform');
        basePlatform.setScale(3, 1).refreshBody(); //scales the base platform in the x axis to cover the entire floor

        platforms.create(250, 450, 'platform'); //creates the upper left platform
        platforms.create(900, 300, 'platform'); //creates the bottome right platform
    }

    function createCoinIcon(scene)
    {
         CoinIcon =  scene.physics.add.staticGroup();
         let Icon = CoinIcon.create(1110,115,'coinIcon');
         //CoinIcon.create(200,200);

    }
       

    
    

    function update()
    {
        
        if (dashCoolDown !== 0) {
            dashCoolDown -= 0.01;
            
            //console.log(dashCoolDown.toFixed(3));
        }

        // code for invisibility frames
        if (invisframes !== 0) {
            invisframes -= 1
            console.log(invisframes)

        }
        //Player will not move in the x-axis unless a movement key is being pressed
        player.setVelocityX(0);

        //Player has "drag" on the x-axis meaning they slide a bit after an input
        player.setDragX(1000);

        //This will reset the number of jumps available to the player whenever the player lands
        if (player.body.touching.down) {
            player.currentJumps = 0;
        }

        //Handle player movements
        if (cursors.left.isDown || keys.A.isDown)
        {
            player.setVelocityX(-400);
        }

        if (cursors.right.isDown || keys.D.isDown)
        {
            player.setVelocityX(400);
        }
    }

    function jump(event)
    {
        if (player.body.touching.down) {
          
          //If the player is on the ground, the player can jump
          player.setVelocityY(-1100);
          player.currentJumps++;
        } else if (player.currentJumps < player.totalJumps) {
          //If the player is not on the ground but has an available air jump, use that jump
          player.setVelocityY(-800);
          player.currentJumps++;
        }
    }

    function dash(event)
    {
        if (dashCoolDown <= 0) {
          player.setVelocityX(5000);
          dashCoolDown = 4;
          
        } else {
            console.log("No dash");
            
        }
    }

    //This function is called when a player overlaps with a carrot
    /*
    function eatCarrot(player, carrot)
    {
        carrot.disableBody(true, true); //remove that particular carrot from the game (physics and visibility)
        if (player.carrotsEaten < totalCarrots)
        {
            player.carrotsEaten++;
            //console.log (player.carrotsEaten)
            console.log("carrots: " + String(player.carrotsEaten));
            console.log("total carrots: " + String(totalCarrots));
            gui.setText('Yum yum!');
            guiTimer = this.time.delayedCall(1000, removeText, [], this);
        } else {
            player.disableBody(true, true);
            console.log(player.carrotsEaten);
        }
    }
     */

    function LavaCollide(player,lava){

        
        if (player.lives > 0 && invisframes === 0)
      {
        // bounce player back upon lava collide
        player.setVelocityY(-1300);
        player.setVelocityX(-500);

        console.log('kill player');
        player.lives -= 1;
        invisframes = 500;

        
    }

  

    if (player.lives <= 0)
       {
           
           GOgui.setText('GAME OVER');
           player.disableBody(true,true);


       }

    }

    function coinCollide(player,coin){
        coin.disableBody(true, true);
        console.log('coin collected');
        coinsCollected += 1;
        CoinGUI.setText(coinsCollected);


    }

   
    //Reset the gui text to be empty after the guiTimer elapses
    function removeText()
    {
        gui.setText('');
    }
    </script>

</body>
</html>
