<!DOCTYPE html>

<html>

<head>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>

</head>

<body>

    <script>


    class Player extends Phaser.Physics.Arcade.Sprite
    {
        totalJumps = 2;
        currentJumps = 0;
        constructor(scene, x, y)
        {
            super(scene, x, y, 'player');
            scene.add.existing(this);
            scene.physics.add.existing(this);
            this.setScale(2);
            this.setCollideWorldBounds(true);
            this.setGravityY(3000); //We will set gravity *per object* rather than for the scene!
        }
    }

    class Carrot extends Phaser.Physics.Arcade.Sprite
    {
        constructor(scene, x, y)
        {
            super(scene, x, y, 'carrot');
            scene.add.existing(this);
            scene.physics.add.existing(this);
            this.setCollideWorldBounds(true);
            this.setGravityY(1000);
        }
    }


    //Game Objects
    var cam
    var carrotsEaten = 0;
    var completed = false;
    var platforms;
    var player;
    var carrots = [];
    var totalCarrots = 12;

    //Keyboard controls
    var cursors;
    var keys;
    var space;

    var gui;
    var guiTimer;
    var jt;
    var grav = 50;
    var onplat = true;
    var counter = 100;
    var score = 0;
    var multiplier = 1.0;
    var speedmulti = 1.0;
class map extends Phaser.Scene{
    constructor(){
        super();
    }
    preload()
    {
        this.load.image('sky', 'assets/clouds.png');
        this.load.image('platform', 'assets/platform.png');
        this.load.image('player',    'assets/wabbit.png');
        this.load.image('carrot', 'assets/carrot.png');
    }

    create()
    {
        this.cameras.main.setSize(1200, 700);
                  //  this.add.image(0, 0, 'map').setOrigin(0);
        this.cameras.main.setZoom(1);
        //this.camera.startFollow(this.player);
        //Set the background origin to be at (0, 0) or top left corner of the image rather than the center of the image asset
       let background = this.add.tileSprite(0, 0, game.scale.width, game.scale.height, 'sky').setOrigin(0, 0);

       //Create the platforms and the player character set to collide with the platforms
       createPlatforms(this);
       player = new Player(this, 250 , 350);
        const cam = this.cameras.main;
        cam.startFollow(player, false, 1, 0.1,0,0);
       this.physics.add.collider(player, platforms, null, platcheck, this);
//        this.physics.add.overlap(player, groundPlatform, platfunct, platcheck, this);
//        
        
        function platcheck(player, platform){
            if(player.body.velocity.y>=0 && player.y<platform.y-50){
                return true;
            }
            return false;
        }
        
       /* function platfunct(player, platform){
            player.setVelocityY(0);
            grav = 0;
            onplat = true;
            player.currentJumps = 0;
            counter = 10;
            console.log(player.y);
            
        }*/

       //Create the carrot interactables
       for (var i = 0; i < totalCarrots; i++)
       {
           let myCarrot = new Carrot(this, Phaser.Math.Between(0, game.scale.width), Phaser.Math.Between(0, game.scale.height-80));
           this.physics.add.collider(myCarrot, platforms);
           carrots.push(myCarrot);
       }

       this.physics.add.overlap(player, carrots, eatCarrot, null, this);

       //Set up user input
       cursors = this.input.keyboard.createCursorKeys();
       keys = this.input.keyboard.addKeys('A, D');
       space = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
       space.on('down', jump); //calls jump function when space is pressed
                 gui = this.add.text(100, 50, score, {fontSize: '32px', fill: '#000'}).setScrollFactor(0);

    }


    update()
    {
        
        /*if(!onplat){    
            counter--;
        }
        if(counter<=0){
            grav = 50;
        }*/
       // onplat = false;
        //player.setVelocityY(player.body.velocity.y+grav);
        counter--;
        if(counter===0){
            score+=10*multiplier;
            counter = 100;
        }
        
        //Player will not move in the x-axis unless a movement key is being pressed
        player.setVelocityX(0);
        gui.setText(score);
        //Player has "drag" on the x-axis meaning they slide a bit after an input

        //This will reset the number of jumps available to the player whenever the player lands
        if (player.body.touching.down) {
            player.currentJumps = 0;
        }
        //Handle player movements
        if (cursors.left.isDown || keys.A.isDown)
        {
            player.setVelocityX(-400*speedmulti);
        }

        if (cursors.right.isDown || keys.D.isDown)
        {
            player.setVelocityX(400*speedmulti);
        }
        
         //gui = this.add.text(cam.scrollX-300, cam.scrollY-300, score, {fontSize: '32px', fill: '#000'});

    }
}
                    var config = {
        type: Phaser.AUTO,
        width: 1200,
        height: 700,
        physics: {
            default: 'arcade',
        },

        scene: map

    };

    var game = new Phaser.Game(config);

                function createPlatforms(scene)
        {
            platforms = scene.physics.add.staticGroup();
//            groundPlatform = scene.physics.add.staticGroup();

            //basePlatform is the floor of the game
            let basePlatform = platforms.create(game.scale.width/2, game.scale.height-30, 'platform');
            basePlatform.setScale(3, 1).refreshBody(); //scales the base platform in the x axis to cover the entire floor

            platforms.create(250, 350, 'platform'); //creates the upper left platform
            platforms.create(950, 500, 'platform'); //creates the bottome right platform
        }
    function jump(event)
    {
        jt = true;
        console.log(player.x);
        if (player.body.touching.down) {
          //If the player is on the ground, the player can jump
          player.setVelocityY(-1300*speedmulti);
          player.currentJumps++;
        } else if (player.currentJumps < player.totalJumps) {
          //If the player is not on the ground but has an available air jump, use that jump
          player.setVelocityY(-900*speedmulti);
          player.currentJumps++;
        }
    }

    //This function is called when a player overlaps with a carrot
    function eatCarrot(player, carrot)
    {
        carrotsEaten++;
        carrot.disableBody(true, true); //remove that particular carrot from the game (physics and visibility)
        score+=50*multiplier;
        speedmulti /= 2;
        player.setGravityY(750);
        this.timedEvent = this.time.delayedCall(15000, onEvent, [], this);
    }
    function onEvent(){
        if(player.body.touching.down){
        speedmulti*=2;
        player.setGravityY(3000);
        console.log("hi")
        }
        else{
            this.timedEvent = this.time.delayedCall(10, onEvent, [], this);
        }
    }
    


    </script>

</body>

</html>
