<!DOCTYPE html>

<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
  </head>

  <body>
    <script>
      var config = {
        type: Phaser.AUTO,
        width: 1200,
        height: 700,
        physics: {
          default: 'arcade'
        },

        scene: {
          preload: preload,
          create: create,
          update: update
        }
      }

      /*
      class Player extends Phaser.Physics.Arcade.Sprite {
        carrotsEaten = 0
        totalJumps = 2
        currentJumps = 0
        animations
        constructor (scene, x, y, spritesheet, animations) {
          super(scene, x, y, spritesheet)
          this.animations = animations
          scene.add.existing(this)
          scene.physics.add.existing(this)
          this.setScale(2)
          this.setCollideWorldBounds(true)
          this.setGravityY(3000)
          this.play(animations)
        }
      }
      */

      class Dino extends Phaser.Physics.Arcade.Sprite {
        totalJumps = 2
        currentJumps = 0
        constructor (scene, x, y, spritesheet, animations) {
          super(scene, x, y, spritesheet)
          this.animations = animations
          scene.add.existing(this)
          scene.physics.add.existing(this)
          this.setScale(2)
          this.setCollideWorldBounds(true)
          this.setGravityY(3000)
          this.play(animations)
        }
        addTween (scene, xDist, yDist, time) {
          scene.tweens.add({
            targets: this,
            x: xDist,
            y: yDist,
            duration: time,
            ease: 'Sine.easeInOut',
            repeat: -1,
            yoyo: true
          })
        }
      }

      var game = new Phaser.Game(config)

      //Game Objects
      var platforms
      var hearts
      var player
      var dashCoolDown = 1

      //Keyboard controls
      var cursors
      var keys
      var space

      // GUI
      var gui
      var guiTimer

      // Score and speed
      var score
      var platformSpeed
      var backgroundSpeed = platformSpeed * 0.25
      var timer = 0;
      var isDashing = false;

      function preload () {
        //this.load.image('sky', 'assets/clouds.png');
        this.load.image('sky', 'assets/white.png')
        this.load.image('platform', 'assets/platform002.png')
        this.load.image('heart', 'assets/heart.png')
        this.load.image('platform001', 'assets/platform001.png')
        this.load.image('platform004', 'assets/platform004.png')
        this.load.image('background', 'assets/background.png')
        this.load.atlas('dino', 'assets/dinoMovements.png', 'assets/dinoMovements.json')
      }

      function create () {
        //Set the background origin to be at (0, 0) or top left corner of the image rather than the center of the image asset
        let background = this.add
          .tileSprite(0, 0, game.scale.width, game.scale.height, 'background')
          .setOrigin(0, 0)

        //Create the platforms and the player character set to collide with the platforms
        createPlatforms(this)
        createHearts(this)

        // Dino player
        let animations = {}
        //var run = this.anims.create({ key: 'dinoDayRun/dinoDayRun', frames: this.anims.generateFrameNames('dino', { prefix: 'dinoDayRun/dinoDayRun', end: 3, zeroPad: 3 }), repeat: -1, frameRate:8});
        var run = this.anims.create({
          key: 'run/dinoDayRun',
          frames: this.anims.generateFrameNames('dino', {
            prefix: 'run/dinoDayRun',
            end: 3,
            zeroPad: 3
          }),
          repeat: -1,
          frameRate: 8
        })
        animations['run'] = run
        var jumpAnimation = this.anims.create({
          key: 'run/DinoDayRun_Jump',
          frames: this.anims.generateFrameNames('dino', {
            prefix: 'run/DinoDayRun_Jump',
            end: 0,
            zeroPad: 1
          }),
          repeat: -1,
          frameRate: 1
        })
        animations['jump'] = jumpAnimation;

        var dJump = this.anims.create({
          key: 'run/dinoDayRun_DoubleJump',
          frames: this.anims.generateFrameNames('dino', {
            prefix: 'run/dinoDayRun_DoubleJump',
            end: 0,
            zeroPad: 1
          }),
          repeat: -1,
          frameRate: 1
        })
        animations["doubleJump"] = dJump;

        var dashAnim = this.anims.create({
          key: 'run/dinoDayRun_Dash',
          frames: this.anims.generateFrameNames('dino', {
            prefix: 'run/dinoDayRun_Dash',
            end: 0,
            zeroPad: 1
          }),
          repeat: -1,
          frameRate: 1
        })
        animations["dash"] = dashAnim;

        dino = new Dino(this, 30, 30, 'dino', animations).setScale(0.999)
        this.physics.add.collider(dino, platforms, null, platcheck, this)
        dino.play(dino.animations['run'])
        function platcheck (dino, platform) {
          if (dino.body.velocity.y >= 0 && dino.y < platform.y - 50) {
            return true
            dino.body.velocity.y
          }
          return false
        }

        //this.cameras.main.startFollow(dino);

        //Set up user input
        cursors = this.input.keyboard.createCursorKeys()
        keys = this.input.keyboard.addKeys('A, D')
        space = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
        space.on('down', jump); //calls jump function when space is pressed
        shift = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SHIFT)
        shift.on('down', dash) //calls jump function when space is pressed

        gui = this.add.text(16, 16, '', { fontSize: '32px', fill: '#000' })
      }

      function createPlatforms (scene) {
        platforms = scene.physics.add.staticGroup()

        //basePlatform is the floor of the game
        let basePlatform = platforms.create(
          game.scale.width / 2,
          game.scale.height - 30,
          'platform'
        )
        basePlatform.setScale(3, 1).refreshBody() //scales the base platform in the x axis to cover the entire floor

        let xPos = Phaser.Math.Between(400, 900)
        let yPos = 500

        // .setScale(2.75).refreshBody()
        platforms
          .create(100, 500, 'platform001')
          .setScale(2.5)
          .refreshBody()
        //platforms.create(xPos, yPos, 'platform004')
      }

      function createHearts (scene) {
        hearts = scene.physics.add.staticGroup()
        hearts.create(925, 100, 'heart').setScale(1.25)
        hearts.create(975, 100, 'heart').setScale(1.25)
        hearts.create(1025, 100, 'heart').setScale(1.25)
        hearts.create(1075, 100, 'heart').setScale(1.25)
        hearts.create(1125, 100, 'heart').setScale(1.25)
      }

      function update () {

        //dino.setVelocityX(0);
        if(timer>0){
          //dino.play(dino.animations["dash"])
          timer--;
          if(timer==70){
            dino.setVelocityX(dino.body.velocity.x-1000);
            dino.play(dino.animations['run'], true)
          }
        }

        if (dino.body.touching.down && (isDashing==false)) {
          dino.play(dino.animations['run'], true)
          isDashing = false;
          dino.currentJumps = 0
        }
        if (cursors.left.isDown || keys.A.isDown) {
          dino.setVelocityX(-400)
        }/*
        if (keys.SPACE.isDown) {
          jump()
          dino.play(dino.animations['jump'], true)
        }*/
        if (cursors.right.isDown || keys.D.isDown) {
          dino.setVelocityX(400)

        }
      }

      function jump (event) {
        if (dino.body.touching.down) {
          isDashing = false;
          dino.play(dino.animations['jump'], true)
          dino.setVelocityY(-1100)
          dino.currentJumps++
        } else if (dino.currentJumps < dino.totalJumps) {
          isDashing = false
          dino.play(dino.animations['doubleJump'], true)
          
          dino.setVelocityY(-800)
          dino.currentJumps++
        }
      }
      function dash(event){
        if (timer===0)
        {
          dino.play(dino.animations['dash'], true)
          //console.log(dino.animations['dash'])
          dino.setVelocityX(dino.body.velocity.x+1000)
          isDashing = true
          timer = 100;
        }
      }

      function removeText () {
        gui.setText('')
      }
    </script>
  </body>
</html>